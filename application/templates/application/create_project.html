{% extends 'application/base_template.html' %}

{% block title %}Create Project - Audio Wave Studio{% endblock %}

{% block content %}
<div class="container">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <div class="card">
                <div class="card-header">
                    <h3 class="mb-0 text-primary">
                        <i class="fas fa-plus-circle"></i> Create New Audio Project
                    </h3>
                </div>
                
                <div class="card-body">
                    <form method="post" enctype="multipart/form-data" id="projectForm">
                        {% csrf_token %}
                        
                        <!-- Basic Information -->
                        <div class="row mb-4">
                            <div class="col-md-6">
                                <label for="name" class="form-label text-primary">Project Name</label>
                                <input type="text" class="form-control" id="name" name="name" required>
                            </div>
                            <div class="col-md-6">
                                <label for="wave_type" class="form-label text-primary">Audio Source</label>
                                <select class="form-select" id="wave_type" name="wave_type" onchange="toggleAudioSource()">
                                    <option value="uploaded">Upload Audio File</option>
                                    <option value="sine">Generate Sine Wave</option>
                                    <option value="square">Generate Square Wave</option>
                                    <option value="triangle">Generate Triangle Wave</option>
                                    <option value="sawtooth">Generate Sawtooth Wave</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="mb-4">
                            <label for="description" class="form-label text-primary">Description</label>
                            <textarea class="form-control" id="description" name="description" rows="3" placeholder="Optional description of your project"></textarea>
                        </div>
                        
                        <!-- Audio Upload Section -->
                        <div id="uploadSection" class="mb-4">
                            <label for="audio_file" class="form-label text-primary">Audio File</label>
                            <input type="file" class="form-control" id="audio_file" name="audio_file" accept=".wav,.mp3,.flac">
                            <div class="form-text text-muted">
                                Supported formats: WAV, MP3, FLAC. Max size: 50MB
                            </div>
                        </div>
                        
                        <!-- Wave Generation Section -->
                        <div id="waveGenSection" class="mb-4" style="display: none;">
                            <h5 class="text-secondary mb-3">Wave Generation Parameters</h5>
                            <div class="row">
                                <div class="col-md-4">
                                    <label for="frequency" class="form-label text-primary">Frequency (Hz)</label>
                                    <input type="number" class="form-control" id="frequency" name="frequency" value="440" min="1" max="20000">
                                </div>
                                <div class="col-md-4">
                                    <label for="samples_per_wave" class="form-label text-primary">Samples per Wave</label>
                                    <input type="number" class="form-control" id="samples_per_wave" name="samples_per_wave" value="100" min="10" max="1000">
                                </div>
                                <div class="col-md-4">
                                    <label for="periods" class="form-label text-primary">Number of Periods</label>
                                    <input type="number" class="form-control" id="periods" name="periods" value="10" min="1" max="100">
                                </div>
                            </div>
                        </div>
                        
                        <!-- Color Settings -->
                        <div class="mb-4">
                            <h5 class="text-secondary mb-3">Visualization Colors</h5>
                            <div class="row">
                                <div class="col-md-4">
                                    <label for="background_color" class="form-label text-primary">Background Color</label>
                                    <div class="input-group">
                                        <input type="color" class="form-control form-control-color" id="background_color" name="background_color" value="#000000">
                                        <input type="text" class="form-control" id="bg_hex" value="#000000" onchange="updateColorPicker('background_color', this.value)">
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <label for="positive_color" class="form-label text-primary">Positive Wave Color</label>
                                    <div class="input-group">
                                        <input type="color" class="form-control form-control-color" id="positive_color" name="positive_color" value="#00FF00">
                                        <input type="text" class="form-control" id="pos_hex" value="#00FF00" onchange="updateColorPicker('positive_color', this.value)">
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <label for="negative_color" class="form-label text-primary">Negative Wave Color</label>
                                    <div class="input-group">
                                        <input type="color" class="form-control form-control-color" id="negative_color" name="negative_color" value="#00FFFF">
                                        <input type="text" class="form-control" id="neg_hex" value="#00FFFF" onchange="updateColorPicker('negative_color', this.value)">
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Color Presets -->
                            <div class="mt-3">
                                <h6 class="text-secondary">Color Presets:</h6>
                                <div class="d-flex flex-wrap gap-2">
                                    {% for name, hex_color in color_palette.items %}
                                        <span class="color-swatch" 
                                              style="background-color: {{ hex_color }}" 
                                              title="{{ name }}" 
                                              onclick="selectPresetColor('{{ hex_color }}')">
                                        </span>
                                    {% endfor %}
                                </div>
                                <small class="text-muted">Click a color to apply it to the selected color field</small>
                            </div>
                        </div>
                        
                        <div class="d-flex justify-content-between">
                            <a href="{% url 'gallery' %}" class="btn btn-outline-secondary">
                                <i class="fas fa-arrow-left"></i> Back to Gallery
                            </a>
                            <button type="submit" class="btn btn-primary btn-lg">
                                <i class="fas fa-rocket"></i> Create Project
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let selectedColorField = 'positive_color';

function toggleAudioSource() {
    const waveType = document.getElementById('wave_type').value;
    const uploadSection = document.getElementById('uploadSection');
    const waveGenSection = document.getElementById('waveGenSection');
    
    if (waveType === 'uploaded') {
        uploadSection.style.display = 'block';
        waveGenSection.style.display = 'none';
        document.getElementById('audio_file').required = true;
    } else {
        uploadSection.style.display = 'none';
        waveGenSection.style.display = 'block';
        document.getElementById('audio_file').required = false;
    }
}

function updateColorPicker(colorFieldId, hexValue) {
    document.getElementById(colorFieldId).value = hexValue;
}

function selectPresetColor(hexColor) {
    document.getElementById(selectedColorField).value = hexColor;
    document.getElementById(selectedColorField.replace('_color', '_hex')).value = hexColor;
}

// Color picker synchronization
document.getElementById('background_color').addEventListener('change', function() {
    document.getElementById('bg_hex').value = this.value;
});
document.getElementById('positive_color').addEventListener('change', function() {
    document.getElementById('pos_hex').value = this.value;
});
document.getElementById('negative_color').addEventListener('change', function() {
    document.getElementById('neg_hex').value = this.value;
});

// Track which color field is being edited
document.querySelectorAll('input[type="color"]').forEach(function(element) {
    element.addEventListener('focus', function() {
        selectedColorField = this.id;
    });
});

// Form validation
document.getElementById('projectForm').addEventListener('submit', function(e) {
    const waveType = document.getElementById('wave_type').value;
    const audioFile = document.getElementById('audio_file').files[0];
    
    if (waveType === 'uploaded' && !audioFile) {
        e.preventDefault();
        alert('Please select an audio file to upload.');
        return;
    }
    
    // Show loading indicator
    const submitBtn = this.querySelector('button[type="submit"]');
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Creating Project...';
    submitBtn.disabled = true;
});
</script>
{% endblock %}